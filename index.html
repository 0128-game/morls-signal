<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Morse Pro - Fix Version</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background: #eceff1; color: #263238; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: left; font-size: 0.85rem; }
        .setting-group { display: flex; flex-direction: column; gap: 8px; }
        .setting-row { display: flex; align-items: center; gap: 8px; }
        input[type="range"] { flex-grow: 1; }
        .val-display { font-weight: bold; color: #1976d2; width: 35px; text-align: right; }
        .mode-selector { margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-weight: bold; }
        #display-bits { font-size: 1.2rem; color: #78909c; height: 1.5em; margin-bottom: 5px; letter-spacing: 5px; }
        #decoded-text { font-size: 2.2rem; font-weight: bold; min-height: 1.8em; border: 2px solid #cfd8dc; border-radius: 8px; margin-bottom: 20px; padding: 15px; background: #fafafa; word-wrap: break-word; }
        .chart-container { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; text-align: left; }
        .chart-title { font-weight: bold; color: #37474f; margin-bottom: 10px; border-left: 5px solid #1976d2; padding-left: 10px; }
        .morse-table { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; margin-bottom: 20px; }
        .morse-item { border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; background: #fff; }
        .morse-item:hover { background: #e3f2fd; }
        .morse-item b { font-size: 1rem; color: #1976d2; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Morse Pro (Fix)</h1>

    <div class="mode-selector">
        モード: 
        <input type="radio" name="lang-mode" value="en" id="m-en" checked><label for="m-en"> 欧文</label>
        <input type="radio" name="lang-mode" value="jp" id="m-jp" style="margin-left:20px;"><label for="m-jp"> 和文</label>
    </div>

    <div class="settings-grid">
        <div class="setting-group">
            <label class="setting-row"><input type="checkbox" id="decode-toggle" checked> 翻訳表示ON</label>
            <label class="setting-row"><input type="checkbox" id="paddle-reverse"> パドル反転</label>
            <button onclick="document.getElementById('decoded-text').innerText=''">クリア (Enter)</button>
        </div>
        <div class="setting-group">
            <div class="setting-row"><span>短点:</span><input type="range" id="param-unit" min="40" max="400" value="100"><span class="val-display" id="val-unit">100</span>ms</div>
            <div class="setting-row"><span>長点:</span><input type="range" id="param-dah" min="2" max="5" step="0.5" value="3"><span class="val-display" id="val-dah">3</span>倍</div>
            <div class="setting-row"><span>確定:</span><input type="range" id="param-wait" min="2" max="10" value="4"><span class="val-display" id="val-wait">4</span>倍</div>
        </div>
    </div>
    
    <div id="display-bits"></div>
    <div id="decoded-text"></div>

    <div class="chart-container">
        <div class="chart-title">欧文 (クリックで再生)</div>
        <div id="en-table" class="morse-table"></div>
        <div class="chart-title">和文 (クリックで再生)</div>
        <div id="jp-table" class="morse-table"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let oscillator = null;
    let gainNode = null;

    const EN_MAP = {'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..','0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'};
    const JP_MAP = {'ア':'--.--','イ':'.-','ウ':'---.-','エ':'-.---','オ':'.-...','カ':'.-.-','キ':'.-..','ク':'...-','ケ':'-.-..','コ':'----','サ':'-.-.','シ':'---.','ス':'---','セ':'.--.-','ソ':'-.-.-','タ':'-.','チ':'..-.','ツ':'...--','テ':'.-.--','ト':'..-','ナ':'--.','ニ':'-...-','ヌ':'....','ネ':'--.-','ノ':'--','ハ':'-...','ヒ':'--..-','フ':'--..','ヘ':'.','ホ':'-..','マ':'-..-','ミ':'..-..','ム':'-','メ':'..-.','モ':'-..-.','ヤ':'.--','ユ':'..---','ヨ':'--...','ラ':'...','リ':'--.-','ル':'-.--.','レ':'---','ロ':'.-.-','ワ':'-.-','ヰ':'.-..-','ヱ':'.--..','ヲ':'.---','ン':'.-.-.','゛':'..','゜':'..--.'};

    const REV_EN = Object.fromEntries(Object.entries(EN_MAP).map(([k, v]) => [v, k]));
    const REV_JP = Object.fromEntries(Object.entries(JP_MAP).map(([k, v]) => [v, k]));

    // 再生中かどうかを管理するフラグ
    let isAutoPlaying = false;

    // 最新の設定値を取得する関数
    const getUnit = () => parseInt(document.getElementById('param-unit').value);
    const getDahMul = () => parseFloat(document.getElementById('param-dah').value);
    const getWaitMul = () => parseFloat(document.getElementById('param-wait').value);

    // スライダーの値表示の更新
    document.querySelectorAll('input[type="range"]').forEach(input => {
        input.addEventListener('input', (e) => {
            document.getElementById('val-' + e.target.id.split('-')[1]).innerText = e.target.value;
        });
    });

    function startTone() {
        if (oscillator) return;
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
    }

    function stopTone() {
        if (!oscillator) return;
        oscillator.stop();
        oscillator = null;
    }

    async function playPattern(pattern) {
        if (isAutoPlaying) return;
        isAutoPlaying = true;
        for (let s of pattern) {
            const unit = getUnit();
            const dah = getDahMul();
            startTone();
            await new Promise(r => setTimeout(r, s === '.' ? unit : unit * dah));
            stopTone();
            await new Promise(r => setTimeout(r, unit));
        }
        isAutoPlaying = false;
    }

    // テーブル生成
    const createTable = (id, map) => {
        const container = document.getElementById(id);
        for (let k in map) {
            const div = document.createElement('div');
            div.className = 'morse-item';
            div.innerHTML = `<b>${k}</b>${map[k]}`;
            div.onclick = () => playPattern(map[k]);
            container.appendChild(div);
        }
    };
    createTable('en-table', EN_MAP);
    createTable('jp-table', JP_MAP);

    let currentSymbols = "";
    let timerId = null;
    let startTime = 0;

    function finalize() {
        if (currentSymbols === "" || !document.getElementById('decode-toggle').checked) {
            currentSymbols = "";
            document.getElementById('display-bits').innerText = "";
            return;
        }
        const mode = document.querySelector('input[name="lang-mode"]:checked').value;
        const char = (mode === 'en' ? REV_EN[currentSymbols] : REV_JP[currentSymbols]) || "?";
        document.getElementById('decoded-text').innerText += char;
        currentSymbols = "";
        document.getElementById('display-bits').innerText = "";
    }

    window.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        if (e.code === 'Enter') { document.getElementById('decoded-text').innerText = ""; return; }
        
        clearTimeout(timerId);
        if (['Space', 'ArrowLeft', 'ArrowRight'].includes(e.code)) {
            e.preventDefault();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startTone();
            startTime = Date.now();
            const rev = document.getElementById('paddle-reverse').checked;
            if (e.code === 'ArrowLeft') addSym(rev ? "-" : ".");
            if (e.code === 'ArrowRight') addSym(rev ? "." : "-");
        }
    });

    window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') {
            stopTone();
            const threshold = getUnit() * ((1 + getDahMul()) / 2);
            addSym((Date.now() - startTime) < threshold ? "." : "-");
        } else if (['ArrowLeft', 'ArrowRight'].includes(e.code)) {
            stopTone();
        }
        timerId = setTimeout(finalize, getUnit() * getWaitMul());
    });

    function addSym(s) {
        currentSymbols += s;
        document.getElementById('display-bits').innerText = currentSymbols;
    }

    window.addEventListener('keypress', (e) => {
        const char = e.key.toUpperCase();
        const pattern = EN_MAP[char] || JP_MAP[char];
        if (pattern) playPattern(pattern);
    });
</script>
</body>
</html>
