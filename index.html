<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Morse Pro - Word Drill & Record</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background: #eceff1; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* éŒ²ç”»ãƒ»ãƒ‰ãƒªãƒ«ãƒ‘ãƒãƒ« */
        .top-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .panel-box { background: #f0f4f8; padding: 15px; border-radius: 10px; border: 2px solid #cfd8dc; }
        .drill-box { background: #fff9c4; border-color: #fbc02d; }
        
        .btn { padding: 10px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin: 2px; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-rec { background: #d32f2f; color: white; }
        .btn-drill { background: #f57f17; color: white; }
        .btn-stop { background: #37474f; color: white; }

        /* éŒ²ç”»ã‚¨ãƒªã‚¢ */
        #recording-area { background: #222; border-radius: 10px; padding: 25px; color: white; position: relative; border: 5px solid #333; }
        #drill-display { font-size: 1.5rem; color: #fbc02d; margin-bottom: 5px; min-height: 1.6em; }
        #drill-target { font-size: 3.5rem; font-weight: 900; color: #fff; background: #444; display: inline-block; padding: 5px 40px; border-radius: 10px; margin-bottom: 10px; letter-spacing: 5px; }
        #display-bits { font-size: 5rem; font-weight: 900; height: 1.2em; display: flex; justify-content: center; align-items: center; }
        .dot { color: #4fc3f7; }
        .dah { color: #ff5252; }
        #decoded-text { font-size: 2.2rem; font-weight: bold; min-height: 1.2em; border-top: 1px solid #444; margin-top: 15px; padding-top: 10px; color: #fff; }
        .correct-flash { animation: flash 0.5s ease-out; }
        @keyframes flash { 0% { background-color: #4caf50; } 100% { background-color: #222; } }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; font-size: 0.85rem; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .val-badge { background: #1976d2; color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .ms-info { color: #d32f2f; font-weight: bold; }
        input[type="range"] { width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-panel">
        <div class="panel-box">
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ¥ éŒ²ç”»ãƒ»éŒ²éŸ³è¨­å®š</div>
            <select id="rec-range" class="btn" style="background:#fff; color:#333; border:1px solid #ccc;">
                <option value="both">å…¨éƒ¨éŒ²ç”»</option>
                <option value="bits">ç¬¦å·ã®ã¿</option>
                <option value="text">ç¿»è¨³ã®ã¿</option>
            </select>
            <button id="audio-btn" class="btn" style="background:#4caf50; color:white;" onclick="startRec('audio')">éŸ³å£°(MP3)</button>
            <button id="video-btn" class="btn btn-rec" onclick="startRec('video')">å‹•ç”»(MP4)</button>
            <button id="stop-btn" class="btn btn-stop" onclick="stopRec()" style="display:none;">åœæ­¢ãƒ»ä¿å­˜</button>
        </div>
        <div class="panel-box drill-box">
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ¯ ãƒ‰ãƒªãƒ«ãƒ¢ãƒ¼ãƒ‰</div>
            <button id="start-drill-btn" class="btn btn-drill" onclick="toggleDrill()">ãƒ‰ãƒªãƒ«é–‹å§‹</button>
            <div id="drill-stats" style="font-size:0.9rem; margin-top:5px; font-weight:bold;">æ­£è§£æ•°: 0</div>
        </div>
    </div>

    <div id="recording-area">
        <div id="drill-display" style="visibility: hidden;">
            TARGET WORD: <br>
            <div id="drill-target">-</div>
        </div>
        <div id="display-bits"></div>
        <div id="decoded-text"></div>
    </div>

    <div class="settings">
        <div>
            <label>çŸ­ç‚¹ï¼ˆåŸºæº–ï¼‰: <span class="val-badge" id="val-unit">100 ms</span></label>
            <input type="range" id="param-unit" min="50" max="400" value="100">
            <label style="margin-top:10px; display:block;">é•·ç‚¹å€ç‡: <span class="val-badge" id="val-dah-mul">3.0å€</span> <span class="ms-info" id="val-dah-ms">â†’ 300ms</span></label>
            <input type="range" id="param-dah" min="2" max="5" step="0.5" value="3">
        </div>
        <div>
            <label>ç¢ºå®šé–“éš”: <span class="val-badge" id="val-wait-mul">4å€</span> <span class="ms-info" id="val-wait-ms">â†’ 400ms</span></label>
            <input type="range" id="param-wait" min="2" max="8" step="1" value="4">
            <label style="display:block; margin-top:10px;"><input type="checkbox" id="paddle-reverse"> ãƒ‘ãƒ‰ãƒ«åè»¢</label>
            <button onclick="document.getElementById('decoded-text').innerText=''" style="width:100%; margin-top:5px; cursor:pointer;">ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»</button>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const streamDest = audioCtx.createMediaStreamDestination();
    let oscillator, gainNode, mediaRecorder, recordedChunks = [];
    let recType = '', isDrillMode = false, drillWord = '', correctCount = 0;

    const EN_MAP = {'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..','0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'};
    const REV_EN = Object.fromEntries(Object.entries(EN_MAP).map(([k, v]) => [v, k]));
    
    // ç‰¹å®šã®å˜èªãƒªã‚¹ãƒˆ
    const FIXED_WORDS = ["SOS", "CQ", "TEST", "QRZ", "HI", "73", "88", "RST", "OP"];

    function toggleDrill() {
        isDrillMode = !isDrillMode;
        const btn = document.getElementById('start-drill-btn');
        const display = document.getElementById('drill-display');
        if (isDrillMode) {
            btn.innerText = "ãƒ‰ãƒªãƒ«çµ‚äº†";
            display.style.visibility = "visible";
            correctCount = 0;
            document.getElementById('decoded-text').innerText = "";
            nextDrill();
        } else {
            btn.innerText = "ãƒ‰ãƒªãƒ«é–‹å§‹";
            display.style.visibility = "hidden";
            document.getElementById('drill-target').innerText = "-";
        }
    }

    function nextDrill() {
        // 50%ã®ç¢ºç‡ã§å›ºå®šå˜èªã€50%ã§ãƒ©ãƒ³ãƒ€ãƒ 3æ–‡å­—
        if (Math.random() > 0.5) {
            drillWord = FIXED_WORDS[Math.floor(Math.random() * FIXED_WORDS.length)];
        } else {
            const keys = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            drillWord = "";
            for(let i=0; i<3; i++) drillWord += keys[Math.floor(Math.random()*keys.length)];
        }
        document.getElementById('drill-target').innerText = drillWord;
        document.getElementById('drill-stats').innerText = `æ­£è§£æ•°: ${correctCount}`;
        document.getElementById('decoded-text').innerText = "";
    }

    async function startRec(type) {
        recType = type; recordedChunks = [];
        const range = document.getElementById('rec-range').value;
        document.getElementById('display-bits').style.display = (range === 'text') ? 'none' : 'flex';
        document.getElementById('decoded-text').style.display = (range === 'bits') ? 'none' : 'block';

        let stream = (type === 'video') ? 
            new MediaStream([...document.getElementById('recording-area').captureStream(30).getTracks(), ...streamDest.stream.getTracks()]) : 
            streamDest.stream;

        mediaRecorder = new MediaRecorder(stream, { mimeType: type === 'video' ? 'video/webm;codecs=vp9' : 'audio/webm' });
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = exportFile;
        mediaRecorder.start();
        uiState(true, type);
    }

    function stopRec() { mediaRecorder.stop(); uiState(false); }

    function exportFile() {
        const ext = recType === 'video' ? 'mp4' : 'mp3';
        const blob = new Blob(recordedChunks, { type: `video/${ext}` });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `morse_drill_${Date.now()}.${ext}`;
        a.click();
    }

    function uiState(isRec, type) {
        document.getElementById('audio-btn').style.display = isRec ? 'none' : 'inline-block';
        document.getElementById('video-btn').style.display = isRec ? 'none' : 'inline-block';
        document.getElementById('stop-btn').style.display = isRec ? 'inline-block' : 'none';
    }

    function updateUI() {
        const u = parseInt(document.getElementById('param-unit').value);
        const d = parseFloat(document.getElementById('param-dah').value);
        const w = parseInt(document.getElementById('param-wait').value);
        document.getElementById('val-unit').innerText = u + " ms";
        document.getElementById('val-dah-mul').innerText = d.toFixed(1) + "å€";
        document.getElementById('val-dah-ms').innerText = `â†’ ${Math.round(u*d)}ms`;
        document.getElementById('val-wait-mul').innerText = w + "å€";
        document.getElementById('val-wait-ms').innerText = `â†’ ${u*w}ms`;
    }

    let currentSymbols = "", timerId = null, startTime = 0;
    function startTone() {
        if (oscillator) return;
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.frequency.value = 600;
        gainNode.gain.value = 0.1;
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        gainNode.connect(streamDest);
        oscillator.start();
    }
    function stopTone() { if (oscillator) { oscillator.stop(); oscillator = null; } }

    function finalize() {
        if (!currentSymbols) return;
        const char = REV_EN[currentSymbols] || "?";
        const deco = document.getElementById('decoded-text');
        deco.innerText += char;
        
        if (isDrillMode) {
            // ç¾åœ¨ã®å…¥åŠ›ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (deco.innerText === drillWord) {
                correctCount++;
                const area = document.getElementById('recording-area');
                area.classList.add('correct-flash');
                setTimeout(() => area.classList.remove('correct-flash'), 500);
                setTimeout(nextDrill, 600);
            } else if (!drillWord.startsWith(deco.innerText)) {
                // é–“é•ãˆãŸã‚‰èµ¤ãã—ã¦ãƒªã‚»ãƒƒãƒˆ
                deco.style.color = "#ff5252";
                setTimeout(() => {
                    deco.innerText = "";
                    deco.style.color = "#fff";
                }, 500);
            }
        }
        
        currentSymbols = "";
        document.getElementById('display-bits').innerHTML = "";
    }

    window.addEventListener('keydown', e => {
        if (e.repeat) return;
        clearTimeout(timerId);
        if (['Space', 'ArrowLeft', 'ArrowRight'].includes(e.code)) {
            e.preventDefault();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startTone(); startTime = Date.now();
            const rev = document.getElementById('paddle-reverse').checked;
            if (e.code === 'ArrowLeft') addSym(rev ? "-" : ".");
            if (e.code === 'ArrowRight') addSym(rev ? "." : "-");
        }
    });

    window.addEventListener('keyup', e => {
        const u = parseInt(document.getElementById('param-unit').value);
        if (e.code === 'Space') {
            stopTone();
            const d = parseFloat(document.getElementById('param-dah').value);
            addSym((Date.now() - startTime) < (u * (1+d)/2) ? "." : "-");
        } else if (['ArrowLeft', 'ArrowRight'].includes(e.code)) stopTone();
        timerId = setTimeout(finalize, u * parseInt(document.getElementById('param-wait').value));
    });

    function addSym(s) {
        currentSymbols += s;
        const container = document.getElementById('display-bits');
        container.innerHTML = '';
        currentSymbols.split('').forEach(x => {
            const span = document.createElement('span');
            span.innerText = x === '.' ? 'â—' : 'â”';
            span.className = x === '.' ? 'dot' : 'dah';
            container.appendChild(span);
        });
    }

    document.querySelectorAll('input[type="range"]').forEach(i => i.addEventListener('input', updateUI));
    updateUI();
</script>
</body>
</html>
