<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Morse Pro Ultimate - Custom Enter Logic</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background: #eceff1; padding: 20px; color: #263238; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .panel { background: #f0f4f8; padding: 15px; border-radius: 10px; border: 1px solid #cfd8dc; text-align: left; }
        .drill-active { background: #fff9c4; border-color: #fbc02d; }

        #recording-area { background: #222; border-radius: 10px; padding: 30px; color: white; min-height: 250px; position: relative; border: 5px solid #333; }
        #drill-ui { color: #fbc02d; font-weight: bold; margin-bottom: 10px; min-height: 1.2em; visibility: hidden; }
        #drill-target { font-size: 3.5rem; color: #fff; background: #444; display: inline-block; padding: 5px 30px; border-radius: 8px; margin-bottom: 10px; }
        #display-bits { font-size: 5.5rem; font-weight: 900; height: 1.2em; display: flex; justify-content: center; align-items: center; letter-spacing: 5px; }
        #decoded-text { font-size: 2.5rem; font-weight: bold; min-height: 1.5em; border-top: 1px solid #444; margin-top: 15px; padding-top: 10px; word-wrap: break-word; }
        
        .dot { color: #4fc3f7; }
        .dah { color: #ff5252; }
        .correct-flash { background-color: #2e7d32 !important; }

        .btn { padding: 8px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-rec { background: #d32f2f; color: white; }
        .btn-stop { background: #37474f; color: white; }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; font-size: 0.85rem; }
        .val-badge { background: #1976d2; color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .ms-info { color: #d32f2f; font-weight: bold; font-size: 0.8rem; }
        input[type="range"] { width: 100%; cursor: pointer; }

        .chart-container { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; text-align: left; }
        .morse-table { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .morse-item { border: 1px solid #ddd; padding: 8px; border-radius: 5px; font-size: 0.7rem; background: #fff; cursor: pointer; text-align: center; }
        .morse-item b { font-size: 1.1rem; color: #1976d2; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Morse Pro Ultimate</h1>

    <div class="top-grid">
        <div class="panel">
            <div style="font-weight:bold; margin-bottom:10px;">ğŸ¥ éŒ²ç”»ãƒ»éŒ²éŸ³</div>
            <div style="margin-bottom:10px;">
                éŒ²ç”»ç¯„å›²: <select id="rec-range" class="btn" style="background:white; border:1px solid #ccc;">
                    <option value="both">ç¬¦å·ã¨ç¿»è¨³</option>
                    <option value="bits">ç¬¦å·ã®ã¿</option>
                    <option value="text">ç¿»è¨³ã®ã¿</option>
                </select>
            </div>
            <button id="audio-btn" class="btn" style="background:#4caf50; color:white;" onclick="startRec('audio')">éŸ³å£°(MP3)</button>
            <button id="video-btn" class="btn btn-rec" onclick="startRec('video')">å‹•ç”»(MP4)</button>
            <button id="stop-btn" class="btn btn-stop" onclick="stopRec()" style="display:none;">ä¿å­˜ã—ã¦åœæ­¢</button>
            <span id="status-msg" style="font-weight:bold; margin-left:5px;"></span>
        </div>

        <div id="drill-panel" class="panel">
            <div style="font-weight:bold; margin-bottom:10px;">ğŸ¯ ãƒ‰ãƒªãƒ«ãƒ¢ãƒ¼ãƒ‰</div>
            <button id="drill-btn" class="btn" style="background:#f57f17; color:white;" onclick="toggleDrill()">ãƒ‰ãƒªãƒ«é–‹å§‹</button>
            <span id="drill-stats" style="margin-left:10px; font-weight:bold;">æ­£è§£: 0</span>
            <div style="margin-top:10px; font-size:0.8rem; color:#d32f2f; font-weight:bold;">â€»[Enter]ã‚­ãƒ¼ã§æ–‡å­—ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚</div>
        </div>
    </div>

    <div id="recording-area">
        <div id="drill-ui">TARGET WORD: <br><div id="drill-target">-</div></div>
        <div id="display-bits"></div>
        <div id="decoded-text"></div>
    </div>

    <div class="settings-grid">
        <div class="setting-col">
            <label>çŸ­ç‚¹ï¼ˆåŸºæº–ï¼‰: <span class="val-badge" id="val-unit">100 ms</span></label>
            <input type="range" id="param-unit" min="50" max="400" value="100">
            <label style="display:block; margin-top:15px;">é•·ç‚¹å€ç‡: <span class="val-badge" id="val-dah-mul">3.0å€</span> <span class="ms-info" id="val-dah-ms">â†’ 300ms</span></label>
            <input type="range" id="param-dah" min="2" max="5" step="0.5" value="3">
            <label style="display:block; margin-top:15px;">ç¢ºå®šé–“éš”: <span class="val-badge" id="val-wait-mul">4å€</span> <span class="ms-info" id="val-wait-ms">â†’ 400ms</span></label>
            <input type="range" id="param-wait" min="2" max="10" step="1" value="4">
        </div>
        <div class="setting-col">
            <label style="font-weight:bold;"><input type="checkbox" id="decode-toggle" checked> ç¿»è¨³è¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹</label><br>
            <label style="font-weight:bold; display:block; margin-top:10px;"><input type="checkbox" id="paddle-reverse"> ãƒ‘ãƒ‰ãƒ«åè»¢ (å·¦=é•· / å³=çŸ­)</label>
            <div style="margin-top:20px; padding:10px; background:#fff; border:1px dashed #ccc; font-size:0.75rem;">
                âŒ¨ï¸ <b>æ“ä½œãƒ«ãƒ¼ãƒ«</b><br>
                ãƒ»<b>[Enter]</b>: ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã™ã¹ã¦æ¶ˆå»<br>
                ãƒ»<b>[A-Z / 0-9]</b>: è‡ªå‹•ç¬¦å·å†ç”Ÿ<br>
                ãƒ»<b>[Space / æ–¹å‘ã‚­ãƒ¼]</b>: ãƒ¢ãƒ¼ãƒ«ã‚¹å…¥åŠ›
            </div>
        </div>
    </div>

    <div class="chart-container">
        <h3>Alphabet Chart (Click to Play)</h3>
        <div id="morse-table" class="morse-table"></div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const streamDest = audioCtx.createMediaStreamDestination();
    let oscillator, gainNode, mediaRecorder, recordedChunks = [];
    let recType = '', isDrill = false, drillWord = '', correctCount = 0;
    let currentSymbols = "", timerId = null, startTime = 0, isAutoPlaying = false;

    const EN_MAP = {'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..','0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'};
    const REV_EN = Object.fromEntries(Object.entries(EN_MAP).map(([k, v]) => [v, k]));
    const DRILL_WORDS = ["SOS", "CQ", "TEST", "QRZ", "HI", "73", "88", "RST", "OP", "OK", "K"];

    function startTone() {
        if (oscillator) return;
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.frequency.value = 600;
        gainNode.gain.value = 0.1;
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        gainNode.connect(streamDest);
        oscillator.start();
    }
    function stopTone() { if (oscillator) { oscillator.stop(); oscillator = null; } }

    function addSym(s) {
        currentSymbols += s;
        const container = document.getElementById('display-bits');
        container.innerHTML = currentSymbols.split('').map(x => `<span class="${x==='.'?'dot':'dah'}">${x==='.'?'â—':'â”'}</span>`).join('');
    }

    function toggleDrill() {
        isDrill = !isDrill;
        const btn = document.getElementById('drill-btn');
        const area = document.getElementById('drill-ui');
        const panel = document.getElementById('drill-panel');
        if (isDrill) {
            btn.innerText = "çµ‚äº†";
            area.style.visibility = "visible";
            panel.classList.add('drill-active');
            correctCount = 0;
            nextDrill();
        } else {
            btn.innerText = "ãƒ‰ãƒªãƒ«é–‹å§‹";
            area.style.visibility = "hidden";
            panel.classList.remove('drill-active');
        }
    }

    function nextDrill() {
        if (Math.random() > 0.4) {
            drillWord = DRILL_WORDS[Math.floor(Math.random() * DRILL_WORDS.length)];
        } else {
            drillWord = String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }
        document.getElementById('drill-target').innerText = drillWord;
        document.getElementById('drill-stats').innerText = `æ­£è§£: ${correctCount}`;
        document.getElementById('decoded-text').innerText = "";
    }

    async function playPattern(pattern, char) {
        if (isAutoPlaying) return;
        isAutoPlaying = true;
        for (let s of pattern) {
            addSym(s); startTone();
            await new Promise(r => setTimeout(r, s==='.' ? getU() : getU()*getD()));
            stopTone();
            await new Promise(r => setTimeout(r, getU()));
        }
        if (document.getElementById('decode-toggle').checked) {
            document.getElementById('decoded-text').innerText += char;
            checkDrill();
        }
        setTimeout(() => {
            currentSymbols = ""; document.getElementById('display-bits').innerHTML = "";
            isAutoPlaying = false;
        }, getU() * getW());
    }

    function finalize() {
        if (!currentSymbols) return;
        const char = REV_EN[currentSymbols] || "?";
        if (document.getElementById('decode-toggle').checked) {
            document.getElementById('decoded-text').innerText += char;
            checkDrill();
        }
        currentSymbols = ""; document.getElementById('display-bits').innerHTML = "";
    }

    function checkDrill() {
        if (!isDrill) return;
        const text = document.getElementById('decoded-text').innerText.trim();
        if (text === drillWord) {
            correctCount++;
            const area = document.getElementById('recording-area');
            area.classList.add('correct-flash');
            setTimeout(() => area.classList.remove('correct-flash'), 400);
            setTimeout(nextDrill, 500);
        } else if (!drillWord.startsWith(text)) {
            // å˜èªã®é€”ä¸­ã¾ã§ãŒé–“é•ã£ã¦ã„ãŸã‚‰æ¶ˆå»
            document.getElementById('decoded-text').innerText = "";
        }
    }

    async function startRec(type) {
        recType = type; recordedChunks = [];
        const range = document.getElementById('rec-range').value;
        document.getElementById('display-bits').style.display = (range === 'text') ? 'none' : 'flex';
        document.getElementById('decoded-text').style.display = (range === 'bits') ? 'none' : 'block';
        
        let stream = (type === 'video') ? 
            new MediaStream([...document.getElementById('recording-area').captureStream(30).getTracks(), ...streamDest.stream.getTracks()]) : 
            streamDest.stream;

        mediaRecorder = new MediaRecorder(stream, { mimeType: type==='video' ? 'video/webm;codecs=vp9' : 'audio/webm' });
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const ext = recType === 'video' ? 'mp4' : 'mp3';
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(recordedChunks, { type: `video/${ext}` }));
            a.download = `morse_rec_${Date.now()}.${ext}`;
            a.click();
        };
        mediaRecorder.start();
        document.getElementById('status-msg').innerText = "ğŸ”´ REC";
        document.getElementById('stop-btn').style.display = 'inline-block';
    }

    function stopRec() {
        mediaRecorder.stop();
        document.getElementById('status-msg').innerText = "";
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('display-bits').style.display = 'flex';
        document.getElementById('decoded-text').style.display = 'block';
    }

    const getU = () => parseInt(document.getElementById('param-unit').value);
    const getD = () => parseFloat(document.getElementById('param-dah').value);
    const getW = () => parseInt(document.getElementById('param-wait').value);

    window.addEventListener('keydown', e => {
        if (e.repeat || isAutoPlaying) return;

        // Enterã‚­ãƒ¼: å…¨æ¶ˆå»
        if (e.code === 'Enter') {
            e.preventDefault();
            document.getElementById('decoded-text').innerText = "";
            return;
        }

        const key = e.key.toUpperCase();
        if (EN_MAP[key]) { playPattern(EN_MAP[key], key); return; }
        
        clearTimeout(timerId);
        if (['Space', 'ArrowLeft', 'ArrowRight'].includes(e.code)) {
            e.preventDefault();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startTone(); startTime = Date.now();
            const rev = document.getElementById('paddle-reverse').checked;
            if (e.code === 'ArrowLeft') addSym(rev ? "-" : ".");
            if (e.code === 'ArrowRight') addSym(rev ? "." : "-");
        }
    });

    window.addEventListener('keyup', e => {
        if (isAutoPlaying) return;
        if (e.code === 'Space') {
            stopTone();
            addSym((Date.now() - startTime) < (getU()*(1+getD())/2) ? "." : "-");
        } else if (['ArrowLeft', 'ArrowRight'].includes(e.code)) stopTone();
        timerId = setTimeout(finalize, getU() * getW());
    });

    const table = document.getElementById('morse-table');
    for (let k in EN_MAP) {
        const div = document.createElement('div');
        div.className = 'morse-item';
        div.innerHTML = `<b>${k}</b>${EN_MAP[k]}`;
        div.onclick = () => playPattern(EN_MAP[k], k);
        table.appendChild(div);
    }

    function updateUI() {
        const u = getU(), d = getD(), w = getW();
        document.getElementById('val-unit').innerText = u + " ms";
        document.getElementById('val-dah-mul').innerText = d.toFixed(1) + "å€";
        document.getElementById('val-dah-ms').innerText = `â†’ ${Math.round(u*d)}ms`;
        document.getElementById('val-wait-mul').innerText = w + "å€";
        document.getElementById('val-wait-ms').innerText = `â†’ ${u*w}ms`;
    }
    document.querySelectorAll('input[type="range"]').forEach(i => i.addEventListener('input', updateUI));
    updateUI();
</script>
</body>
</html>
